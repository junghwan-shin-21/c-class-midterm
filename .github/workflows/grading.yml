name: C í”„ë¡œê·¸ë˜ë° ì¤‘ê°„ê³ ì‚¬ (í†µí•© ì±„ì )

on: [push]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: âš™ï¸ í†µí•© ì±„ì  ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (100ì  ë§Œì )
        id: grading
        run: |
          # ----------------------------------------------------
          # 1. ì´ˆê¸° ë³€ìˆ˜ ì„¤ì •
          # ----------------------------------------------------
          P1_SCORE=0
          P2_SCORE=0
          P1_FEEDBACK=""
          P2_FEEDBACK=""
          FINAL_SCORE=0

          # Normalize function: Remove all whitespace (spaces, tabs, newlines, carriage returns) for strict comparison.
          # This ensures that only the content/sequence matters, not formatting.
          normalize_output() {
            tr -d ' \t\n\r' < "$1"
          }

          # ----------------------------------------------------
          # 2. ë¬¸ì œ 1 ì±„ì  (ì•½ìˆ˜ ì¶œë ¥ - main-1.c) - 50ì 
          # ----------------------------------------------------
          echo "### ğŸ” [ë¬¸ì œ 1] ì•½ìˆ˜ ì¶œë ¥ ì±„ì  ì‹œì‘ (main-1.c) ###"

          # 2-1. ì»´íŒŒì¼ ì‹œë„
          if gcc main-1.c -o main1 2> compile_error_p1.txt; then
            echo "âœ… ë¬¸ì œ 1: ì»´íŒŒì¼ ì„±ê³µ."
            
            # 2-2. ì˜ˆìƒ ì¶œë ¥ íŒŒì¼ ìƒì„± (ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì ìš©)
            # ì˜ˆìƒ ì¶œë ¥ì€ ìˆœìˆ˜í•˜ê²Œ ì •ë‹µ ë‚´ìš©ë§Œ í¬í•¨í•©ë‹ˆë‹¤.
            echo "24ì˜ ì•½ìˆ˜: 1 2 3 4 6 8 12 24" > expected_p1.txt
            
            # 2-3. ì‹¤í–‰ ë° ì›ë³¸ ì¶œë ¥ ìº¡ì²˜ (ì…ë ¥: 24ë¡œ ë³€ê²½)
            echo "24" | ./main1 > actual_p1_raw.txt
            
            # 2-4. ì¶œë ¥ ì •ë¦¬: í”„ë¡¬í”„íŠ¸ ë° ë¶ˆí•„ìš”í•œ ì„ í–‰ ë¬¸ì ì œê±° (ì¶œë ¥ ì•ˆì •ì„± ê·¹ëŒ€í™”)
            # ì •ë‹µ í‚¤ì›Œë“œ("24ì˜ ì•½ìˆ˜:")ë¥¼ í¬í•¨í•˜ëŠ” ë¼ì¸ ì¤‘ ë§ˆì§€ë§‰ ë¼ì¸ì„ ì¶”ì¶œí•˜ê³ ,
            # í•´ë‹¹ ë¼ì¸ ì‹œì‘ ë¶€ë¶„ì˜ ëª¨ë“  ë¬¸ìì—´ì„ ê°•ì œë¡œ ì œê±°í•˜ì—¬ ì •ë‹µ ë¶€ë¶„ë§Œ ë‚¨ê¹€.
            awk '/24ì˜ ì•½ìˆ˜:/' actual_p1_raw.txt | tail -n 1 | sed 's/^.*24ì˜ ì•½ìˆ˜:/24ì˜ ì•½ìˆ˜:/' > actual_p1.txt

            # 2-5. ì¶œë ¥ ë¹„êµ
            if [[ "$(normalize_output actual_p1.txt)" == "$(normalize_output expected_p1.txt)" ]]; then
              P1_SCORE=50
              P1_FEEDBACK="âœ… ë¬¸ì œ 1 (ì•½ìˆ˜ ì¶œë ¥): í†µê³¼ (50ì )"
            else
              P1_FEEDBACK="âŒ ë¬¸ì œ 1 (ì•½ìˆ˜ ì¶œë ¥): ì‹¤íŒ¨. (ì…ë ¥: 24)"
              P1_FEEDBACK="${P1_FEEDBACK}\n  [í•™ìƒ ì¶œë ¥]: $(cat actual_p1.txt | tr '\n' ' ')"
              P1_FEEDBACK="${P1_FEEDBACK}\n  [ì˜ˆìƒ ì¶œë ¥]: $(cat expected_p1.txt | tr '\n' ' ')"
            fi
          else
            echo "âŒ ë¬¸ì œ 1: ì»´íŒŒì¼ ì‹¤íŒ¨."
            P1_FEEDBACK="âŒ ë¬¸ì œ 1 (ì•½ìˆ˜ ì¶œë ¥): ì»´íŒŒì¼ ì‹¤íŒ¨. ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi
          
          # ----------------------------------------------------
          # 3. ë¬¸ì œ 2 ì±„ì  (í•©ê³„ ë° ì—­ìˆœ ì¶œë ¥ - main-2.c) - 50ì 
          # ----------------------------------------------------
          echo "### ğŸ” [ë¬¸ì œ 2] í•©ê³„ ë° ì—­ìˆœ ì¶œë ¥ ì±„ì  ì‹œì‘ (main-2.c) ###"

          # 3-1. ì»´íŒŒì¼ ì‹œë„
          if gcc main-2.c -o main2 2> compile_error_p2.txt; then
            echo "âœ… ë¬¸ì œ 2: ì»´íŒŒì¼ ì„±ê³µ."

            # 3-2. ì˜ˆìƒ ì¶œë ¥ íŒŒì¼ ìƒì„± (ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì ìš©)
            # ì˜ˆìƒ ì¶œë ¥ì€ ìˆœìˆ˜í•˜ê²Œ ì •ë‹µ ë‚´ìš©ë§Œ í¬í•¨í•˜ë©°, ë‘ ì¤„ì…ë‹ˆë‹¤.
            echo "í•©ê³„: 424" > expected_p2.txt
            echo "ì—­ìˆœ: 90 1 27 68 48 23 95 4 56 12" >> expected_p2.txt

            # 3-3. ì‹¤í–‰ ë° ì›ë³¸ ì¶œë ¥ ìº¡ì²˜ (ì…ë ¥: 12 56 ... 90ìœ¼ë¡œ ë³€ê²½)
            echo "12 56 4 95 23 48 68 27 1 90" | ./main2 > actual_p2_raw.txt

            # 3-4. ì¶œë ¥ ì •ë¦¬: í”„ë¡¬í”„íŠ¸ ì œê±°ë¥¼ ìœ„í•´ ì •ë‹µ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” ë¼ì¸ë§Œ ì¶”ì¶œ ë° ì •ë¦¬ (ì¶œë ¥ ì•ˆì •ì„± ê·¹ëŒ€í™”)
            # sed ëª…ë ¹ì„ ì—°ê²°í•˜ì—¬ ê° í‚¤ì›Œë“œ ì•ì˜ ëª¨ë“  ë¬¸ìë¥¼ ì œê±°
            grep -E 'í•©ê³„:|ì—­ìˆœ:' actual_p2_raw.txt | sed 's/^.*í•©ê³„:/í•©ê³„:/' | sed 's/^.*ì—­ìˆœ:/ì—­ìˆœ:/' > actual_p2.txt

            # 3-5. ì¶œë ¥ ë¹„êµ
            if [[ "$(normalize_output actual_p2.txt)" == "$(normalize_output expected_p2.txt)" ]]; then
              P2_SCORE=50
              P2_FEEDBACK="âœ… ë¬¸ì œ 2 (í•©ê³„ ë° ì—­ìˆœ): í†µê³¼ (50ì )"
            else
              P2_FEEDBACK="âŒ ë¬¸ì œ 2 (í•©ê³„ ë° ì—­ìˆœ): ì‹¤íŒ¨. (ì…ë ¥: 12 56 4 95 23 48 68 27 1 90)"
              P2_FEEDBACK="${P2_FEEDBACK}\n  [í•™ìƒ ì¶œë ¥]: $(cat actual_p2.txt | tr '\n' ' ')"
              P2_FEEDBACK="${P2_FEEDBACK}\n  [ì˜ˆìƒ ì¶œë ¥]: $(cat expected_p2.txt | tr '\n' ' ')"
            fi
          else
            echo "âŒ ë¬¸ì œ 2: ì»´íŒŒì¼ ì‹¤íŒ¨."
            P2_FEEDBACK="âŒ ë¬¸ì œ 2 (í•©ê³„ ë° ì—­ìˆœ): ì»´íŒŒì¼ ì‹¤íŒ¨. ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

          # ----------------------------------------------------
          # 4. ìµœì¢… ì ìˆ˜ ë° í”¼ë“œë°± ê³„ì‚°
          # ----------------------------------------------------
          FINAL_SCORE=$((P1_SCORE + P2_SCORE))
          
          # ìµœì¢… í”¼ë“œë°± êµ¬ì„± (í—¤ë” + P1 ê²°ê³¼ + P2 ê²°ê³¼)
          FULL_FEEDBACK="--- ìµœì¢… ì±„ì  ê²°ê³¼ (ì´ ${FINAL_SCORE}ì  / 100ì ) ---\n"
          FULL_FEEDBACK="${FULL_FEEDBACK}\n${P1_FEEDBACK}"
          FULL_FEEDBACK="${FULL_FEEDBACK}\n${P2_FEEDBACK}"
          
          # 5. GitHub Classroom ì¶œë ¥ (ì ìˆ˜ ë° í”¼ë“œë°± ì „ë‹¬)
          echo "ì ìˆ˜: ${FINAL_SCORE} / 100"
          echo "í”¼ë“œë°±:\n${FULL_FEEDBACK}"

          echo "score=$FINAL_SCORE" >> "$GITHUB_OUTPUT"
          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$FULL_FEEDBACK" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # 6. ğŸš¨ ìµœì¢… ì‹¤íŒ¨ ë³´ì¥ ë¡œì§ (ê°€ì¥ ì¤‘ìš”)
          # ì ìˆ˜ê°€ 100ì ì´ ì•„ë‹ˆë©´ GitHub Action ìì²´ë¥¼ ì‹¤íŒ¨ì‹œì¼œ
          # GitHub Classroomì— 0ì  ë˜ëŠ” ì‹¤íŒ¨ë¡œ ì •í™•í•˜ê²Œ ë³´ê³ ë˜ë„ë¡ í•¨.
          if [ $FINAL_SCORE -ne 100 ]; then
            echo "::error::ğŸš¨ ìµœì¢… ì ìˆ˜ê°€ 100ì ì´ ì•„ë‹ˆë¯€ë¡œ ì±„ì  ì‹¤íŒ¨ ì²˜ë¦¬í•©ë‹ˆë‹¤."
            exit 1
          fi
